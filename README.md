## Назначение
Данная роль создают резервные копии виртуальных машин по дням недели. Для выбора виртуальных машин используются теги ВМ.

## Как работать
1. Создайте в zVirt теги в формате `backup_ДеньНедели`. День недели должен быть на английском и с заглавной буквы (пример `backup_Monday`, `backup_Friday`);
2. Назначьте виртуальным машинам данные теги;
3. Добавьте запуск Playbook'а `playbook.yaml` в планировщик.

Роль обнаруживает экспорт домен (если он есть, иначе выдаёт ошибку) и список ВМ для резервного копирования. Указать нужно следующие переменные в файле `backup_vars.yaml`:
- `engine_fqdn`: имя Менеджера управления;
- `engine_user`: имя пользователя для доступа к Менеджеру управления;
- `engine_password`: пароль пользователя;
- `backup_count`: количество хранимых резервных копий (по умолчанию 2);
- `async_backup`: выполнять резервное копирование последовательно или асинхронно для разных ВМ (`true` или `false`, по умолчанию `false`);
- `backup_timeout`: время ожидания завершения операций резервного копирования (по умолчанию 3600 секунд);
- `backup_threshold`: множитель свободного места. Определяет сколько должно быть свободного места для начала процесса резервного копирования;
- `ansible_user` и `ansible_ssh_pass` для доступа к хосту с Экспорт доменом. Нужно для удаления устаревших резервных копий (при необходимости нужно указать `ansible_become_password`).

## Особенности асинхронного резервного копирования
1. В сценарии асинхронного резервного копирования нескольких ВМ, используется своя аутентификация в API для каждой ВМ. Для корректной работы асинхронного резервного копирования, нужно убрать ограничения на количество подключений, либо указать количество подключений больше, чем количество ВМ для асинхронного резервного копирования.
2. При оценивании свободного места в доменах хранения, учитывается общий вес всех ВМ. Если хотя бы для одной виртуальной машины будет недостаточно свободного места (как в экспорт домене, так и в домене хранения данных) — резервное копирование прервётся с ошибкой.

## Автор
Селезнёв Александр / Seleznjov Alexander

Personal mail: number_ultra@mail.ru

## TODO plans
1. Free space checking: проверка наличия свободного места для резервной копии и free_space_threshold 
  1.1 Проверка свободного места в экспорт домене ✔
  1.2 Проверка свободного места в доменах хранения данных ✔
  1.3 Проверка свободного места в обоих сценариях резервного копирования: асинхронном и последовательном ✔
  1.4 Указание множителя свободного места ✔
  1.5 Проверка возможности удаления старых резервных копий для освобожения достаточного свободного места для новой резервной копии.
2. Logging: добавить логирование для резервного копирования

