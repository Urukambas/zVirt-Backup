Задача моей роли — делать бэкапы виртуальных машин в oVirt. Вот логика работы моей роли:
1. Мы указываем теги в формате `backup_ДеньНедели` (например, `backu_Monday`, `backup_Friday` и т.д.);
2. Мы собираем информацию о виртуальных машинах по тегам и записываем список ВМ, который нужно забэкапить сегодня. Для этого используются 2 таски:
```YAML
- name: "Gather list of VMs to backup"
  ovirt_vm_info:
    auth: "{{ ovirt_auth }}"
    pattern: "tag=backup_{{ ansible_date_time['weekday'] }}"
  register: vms_list
- set_fact:
    vms_to_backup: "{{ vms_list | json_query('ovirt_vms[*].name') | list }}"
```
В результате создаётся список ВМ, которые нужно забэкапить в тот день, когда была запущена роль (в понедельник происходит бэкап машин с тегом `backu_Monday`);
3. Если список ВМ, которые нужно бэкапить, больше 0, то:
	1. Ищем экспорт домен и если он есть — регистрируем факты о нём. Если экспорт домена нет, то вываливаем ошибку "Export domain doesn't exist";
	2. Инклюдим таски, которые делают бэкапы каждой ВМке, по циклу.
4. После начала бэкапа, собирается информация об экспорт домене (`gather_backup_info.yaml`), в том числе:
  - имя;
  - список ВМ (а именно бэкапов);
  - список дисков этих ВМ.
  Далее мы извлекаем лишь нужную инфу о всех бэкапов и фильтруем те данные, что относятся к текущей ВМ, которую мы бэкапим.
5. После сбора инфы, запускаем блок в `backup.yaml` и сразу же сравнивается количество существующих бэкапов и необходимое:
	1. Если лишних бэкапов нет, то делаем бэкап в порядке:
		1. создаём снапшот;
		2. клонируем из снапшота временную ВМ;
		3. экспортируем временную ВМ в экспорт домен;
		4. удаляем временную ВМ;
		5. удаляем снапшот.
	2. Если лишние бэкапы есть, то запускаем удаление старых бэкапов. Удалится количество старых бэкапов, равное разнице между количеством существующих бэкапов и требуемым количеством + 1. Удаление происходит следующим образом:
		1. указываем количество старых бэкапов для удаления;
		2. извлекаем всю нужную информацию о самом старом бэкапе, удаляем саму ВМ (ovf) и его диски;
		3. проверяем домен ещё раз, если всё ещё остались лишние бэкапы, то опять удаляем самый старый бэкап (которые как раз сместился после удаления предыдущего).
	3. После того, как удалили все лишние бэкапы, начинаем создавать новый.
6. Расставил теги дебага, можно проверить перед запуском, запустив с тегом `debug`

Пример Playbook:
```YAML
---
- name: "Backup zVirt VMs"
  hosts: localhost

  vars:
    engine_fqdn: zvirt.example.ru
    engine_user: admin@internal
    engine_password: admin
    backup_count: 2
  roles:
    - zvirt_backup
```