## Назначение
Данная роль создаёт резервные копии виртуальных машин по дням недели. Для выбора виртуальных машин используются теги ВМ.

## Как работать
1. Создайте в zVirt теги в формате `backup_ДеньНедели`. День недели должен быть на английском и с заглавной буквы (пример `backup_Monday`, `backup_Friday`);
2. Назначьте виртуальным машинам данные теги;
3. Добавьте запуск Playbook'а `playbook.yaml` в планировщик.

Роль обнаруживает экспорт домен (если он есть, иначе выдаёт ошибку) и список ВМ для резервного копирования. Указать нужно следующие переменные в файле `backup_vars.yaml`:
| Variable                | Type    | Default | Description                                                |
|-------------------------|---------|---------|------------------------------------------------------------|
| engine_fqdn             | string  | Undef   | Имя Менеджера управления                                   |
| engine_user             | string  | Undef   | Пользователь портала управления                            |
| engine_password         | string  | Undef   | Пароль пользователя                                        |
| backup_count            | int     | 2       | Количество хранимых резервных копий                        |
| async_backup            | boolean | false   | Выполнять резервное копирование асинхронно                 |
| backup_timeout          | int     | 3600    | Таймаут ожидания резервного копирования                    |
| backup_threshold        | float   | 1.2     | Порог свободного места в доменах хранения и экспорт        |
| ansible_user            | string  | Undef   | Пользователь для подключения к хосту с экспорт доменом     |
| ansible_ssh_pass        | string  | Undef   | Пароль пользователя хоста с экспорт доменом                |
| ansible_become_password | string  | Undef   | Пароль эскалации прав пользователя хоста с экспорт доменом |

## Особенности асинхронного резервного копирования
1. В сценарии асинхронного резервного копирования нескольких ВМ, используется своя аутентификация в API для каждой ВМ. Для корректной работы асинхронного резервного копирования, нужно убрать ограничения на количество подключений, либо указать количество подключений больше, чем количество ВМ для асинхронного резервного копирования.
2. При оценивании свободного места в доменах хранения, учитывается общий вес всех ВМ. Если хотя бы для одной виртуальной машины будет недостаточно свободного места (как в экспорт домене, так и в домене хранения данных) — резервное копирование прервётся с ошибкой.

## Особенности последовательного резервного копирования
1. Итерация по каждой виртуальной машине происходит строго последовательного и запуск резервного копирования следующей ВМ зависит от успешности резервного копирования предыдущей ВМ. Если в ходе итерации по списку ВМ роль прерывает работу (например, недостаточно места для создания резервной копии), оставшиеся ВМ также же копироваться не будут.

## Автор
Селезнёв Александр / Seleznjov Alexander

Personal mail: number_ultra@mail.ru

## TODO plans
1. Резервное копирование ВМ в OVA формат.
